generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model users {
  id         String         @id
  created_at DateTime       @default(now()) @db.Timestamptz(6)
  updated_at DateTime?      @default(now()) @updatedAt @db.Timestamp(6)
  email      String         @unique
  role       EnumRole       @default(GUEST)
  status     EnumUserStatus @default(JOIN)
  planId     String?
  store      store[]
  plan       plan?          @relation(fields: [planId], references: [id])
  nickname   String?
}

model store {
  id               String    @id @default(uuid())
  created_at       DateTime  @default(now()) @db.Timestamp(6)
  updated_at       DateTime? @default(now()) @updatedAt @db.Timestamp(6)
  name             String
  address          String?
  address_elements Json?
  phone            String?
  business_hours   Json?
  holiday          String?
  homepage         String?
  sns              Json?
  image            String[]
  description      String?
  business_number  String[]
  usersId          String?
  receives         receive[]
  users            users?    @relation(fields: [usersId], references: [id])
}

model receive {
  id         String     @id @default(uuid())
  created_at DateTime   @default(now()) @db.Timestamp(6)
  updated_at DateTime?  @default(now()) @updatedAt @db.Timestamp(6)
  status     EnumStatus @default(READY)

  // 날짜 자동 생성 (YYMMDD)
  receive_date String @default(dbgenerated("to_char(now(), 'YYMMDD')"))

  // 1. DB에서 자동으로 생성되는 번호 (YYMMDD01 형식)
  // lpad와 시퀀스를 사용하여 DB 레벨에서 생성되도록 설정
  display_id String @default(dbgenerated("(to_char(now(), 'YYMMDD') || lpad(nextval('recive_seq')::text, 2, '0'))"))

  // 시퀀스를 통한 순번 자동 할당
  // 주의: 이는 전체 누적 순번입니다. (일일 초기화는 별도 작업 필요)
  daily_seq Int @default(dbgenerated("nextval('recive_seq')"))

  phone     String?
  sendCount Int     @default(0)

  price         Int?      @default(0)
  paymentMethod String?   @default("none")
  completionAt  DateTime?

  storeId String
  store   store   @relation(fields: [storeId], references: [id])
  memo    String? @default("")
}

model apply {
  id              String          @id @default(uuid())
  created_at      DateTime        @default(now()) @db.Timestamp(6)
  updated_at      DateTime?       @default(now()) @updatedAt @db.Timestamp(6)
  name            String?
  phone           String
  status          EnumStatus      @default(READY)
  biz_name        String?
  biz_num         String?
  biz_num_status  String?
  memo            String?
  apply_histories apply_history[]
}

model apply_history {
  id             String     @id @default(uuid())
  admin_id       String // 상담원 ID
  admin_nickname String? // 상담원 닉네임 (기록 시점의 닉네임 보존용)
  status         EnumStatus // 상담 후 변경된 상태
  content        String     @db.Text // 상담 내용
  created_at     DateTime   @default(now()) @db.Timestamp(6) // 상담일
  apply_id       String // 어떤 신청 건에 대한 상담인지 (FK)
  apply          apply      @relation(fields: [apply_id], references: [id], onDelete: Cascade)
}

model plan {
  id       String  @id @default(uuid())
  name     String  @unique
  features Json
  users    users[]
}

enum EnumRole {
  GUEST  @map("GUEST")
  ADMIN  @map("ADMIN")
  MASTER @map("MASTER")
}

enum EnumUserStatus {
  JOIN     @map("JOIN")
  WITHDRAW @map("WITHDRAW")
}

enum EnumStatus {
  READY     @map("READY")
  PROGRESS  @map("PROGRESS")
  COMPLETED @map("COMPLETED")
  CANCEL    @map("CANCEL")
}
